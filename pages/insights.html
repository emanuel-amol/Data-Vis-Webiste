<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Key Insights - Road Safety Enforcement (Fixed)</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: #333;
      background-color: #f9f9f9;
    }

    .container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    header {
      background-color: #0C1A3C;
      color: white;
      padding: 20px 0;
      text-align: center;
    }

    .heading {
      color: white;
      font-weight: 600;
      font-size: 2.2rem;
      margin: 0;
    }

    .nav-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .nav-btn {
      padding: 8px 16px;
      background-color: #3b82f6;
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
    }

    .nav-btn.active {
      background-color: #1e40af;
    }

    .hero-story {
      background-color: #e8f4fe;
      padding: 40px 0;
      margin-bottom: 30px;
      text-align: center;
    }

    .story-hook h2 {
      font-size: 1.8rem;
      margin-bottom: 15px;
      color: #0C1A3C;
    }

    .stats-dashboard {
      background: white;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      margin-bottom: 40px;
    }

    .stats-dashboard h3 {
      text-align: center;
      color: #0C1A3C;
      margin-bottom: 30px;
      font-size: 1.8rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 25px;
    }

    .stat-card {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      padding: 30px;
      border-radius: 12px;
      text-align: center;
      border: 1px solid #e2e8f0;
      transition: all 0.3s ease;
    }

    .stat-icon {
      font-size: 2.5rem;
      margin-bottom: 15px;
      display: block;
    }

    .key-stat {
      display: block;
      font-size: 3rem;
      font-weight: 800;
      color: #0C1A3C;
      margin-bottom: 10px;
      line-height: 1;
    }

    .stat-description {
      font-size: 1rem;
      color: #374151;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .stat-change {
      font-size: 0.9rem;
      font-weight: 600;
      padding: 4px 12px;
      border-radius: 20px;
      background: #10b981;
      color: white;
      display: inline-block;
    }

    .policy-dashboard {
      margin: 40px 0;
      padding: 40px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }

    .policy-dashboard h2 {
      text-align: center;
      color: #0C1A3C;
      margin-bottom: 30px;
      font-size: 1.8rem;
    }

    .dashboard-controls {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 30px;
      border: 1px solid #e2e8f0;
    }

    .control-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 25px;
      align-items: end;
    }

    .control-panel h4 {
      grid-column: 1 / -1;
      margin: 0 0 15px 0;
      color: #0C1A3C;
      font-size: 1.2rem;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .control-group label {
      font-weight: 600;
      color: #374151;
      font-size: 0.9rem;
    }

    .control-group select {
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      background: white;
      font-size: 14px;
    }

    .export-btn {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 30px;
      margin: 30px 0;
    }

    .map-section {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      border: 1px solid #e2e8f0;
    }

    .section-header h3 {
      color: #0C1A3C;
      margin-bottom: 10px;
      font-size: 1.4rem;
    }

    .section-header p {
      color: #6b7280;
      margin-bottom: 25px;
      font-style: italic;
    }

    #australia-map-container {
      position: relative;
      min-height: 400px;
    }

    .insights-panel {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      border: 1px solid #e2e8f0;
      height: fit-content;
    }

    .panel-header h3 {
      color: #0C1A3C;
      margin-bottom: 10px;
      font-size: 1.4rem;
    }

    .panel-header p {
      color: #6b7280;
      margin-bottom: 20px;
      font-style: italic;
    }

    .jurisdiction-details {
      border-top: 2px solid #e5e7eb;
      padding-top: 25px;
    }

    .detail-section {
      margin-bottom: 25px;
      padding-bottom: 20px;
      border-bottom: 1px solid #f3f4f6;
    }

    .detail-section h4 {
      color: #374151;
      margin-bottom: 15px;
      font-size: 1.1rem;
    }

    .key-metrics {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .metric-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      background: #f8fafc;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }

    .metric-label {
      font-weight: 600;
      color: #374151;
    }

    .metric-value {
      font-weight: 700;
      color: #3b82f6;
      font-size: 1.1rem;
    }

    .error-message {
      background: #fee2e2;
      border: 1px solid #fecaca;
      border-radius: 8px;
      padding: 16px;
      margin: 20px 0;
      color: #dc2626;
      text-align: center;
    }

    .loading-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 200px;
      background: #f8fafc;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      color: #6b7280;
    }

    .insights-map-tooltip {
      position: absolute;
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 13px;
      pointer-events: none;
      max-width: 300px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 1010;
    }

    @media (max-width: 1024px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
        gap: 25px;
      }
    }

    @media (max-width: 768px) {
      .heading {
        font-size: 1.5rem;
      }
      
      .policy-dashboard,
      .stats-dashboard {
        padding: 25px;
      }
      
      .control-panel {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .map-section,
      .insights-panel {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1 class="heading">Australian Road Safety Enforcement</h1>
      <div class="nav-buttons">
        <a href="#" class="nav-btn">Home</a>
        <a href="#" class="nav-btn">Time Trends</a>
        <a href="#" class="nav-btn">Jurisdictions</a>
        <a href="#" class="nav-btn">Age Demographics</a>
        <a href="#" class="nav-btn">Drugs and Alcohol</a>
        <a href="#" class="nav-btn">Comparative Analysis</a>
        <a href="#" class="nav-btn active">Key Insights</a>
        <a href="#" class="nav-btn">Data Story</a>
        <a href="#" class="nav-btn">About</a>
      </div>
    </div>
  </header>

  <main>
    <!-- Hero Section -->
    <div class="hero-story">
      <div class="container">
        <div class="story-hook">
          <h2>Policy Maker Dashboard: Evidence-Based Road Safety Insights</h2>
          <p style="font-size: 1.2rem; opacity: 0.9; margin-top: 20px;">Interactive analysis tools for data-driven policy development and jurisdictional comparisons</p>
        </div>
      </div>
    </div>

    <div class="container">
      <!-- Executive Summary -->
      <div class="stats-dashboard">
        <h3>Executive Summary: Counter-Intuitive Key Finding</h3>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon">üéØ</div>
            <div class="stat-card-content">
              <span class="key-stat">45</span>
              <div class="stat-description">% of violations by middle-aged drivers (40-64)</div>
              <div class="stat-change">Challenges conventional wisdom</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üìä</div>
            <div class="stat-card-content">
              <span class="key-stat">604,750</span>
              <div class="stat-description">Middle-aged driver fines</div>
              <div class="stat-change">vs 298,300 young drivers</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üîç</div>
            <div class="stat-card-content">
              <span class="key-stat">2.0x</span>
              <div class="stat-description">More than young drivers</div>
              <div class="stat-change">Experience ‚â† Compliance</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Policy Maker Dashboard -->
      <div class="policy-dashboard">
        <h2>Interactive Jurisdictional Analysis Dashboard</h2>
        
        <!-- Dashboard Controls -->
        <div class="dashboard-controls">
          <div class="control-panel">
            <h4>Analysis Controls</h4>
            <div class="control-group">
              <label for="metric-select">Metric:</label>
              <select id="metric-select">
                <option value="total-fines">Total Fines</option>
                <option value="per-capita">Per Capita Rate</option>
                <option value="growth-rate">Growth Rate</option>
                <option value="technology-impact">Technology Impact</option>
              </select>
            </div>
            <div class="control-group">
              <label for="year-select">Year:</label>
              <select id="year-select">
                <option value="2023">2023</option>
                <option value="2022">2022</option>
                <option value="2021">2021</option>
                <option value="2020">2020</option>
                <option value="2019">2019</option>
                <option value="all">All Years</option>
              </select>
            </div>
            <div class="control-group">
              <button id="export-report" class="export-btn">üìä Export Report</button>
            </div>
          </div>
        </div>

        <!-- Main Dashboard Layout -->
        <div class="dashboard-grid">
          <!-- Interactive Map Section -->
          <div class="map-section">
            <div class="section-header">
              <h3>Interactive Jurisdiction Map</h3>
              <p>Click on jurisdictions to compare enforcement effectiveness</p>
            </div>
            
            <div id="australia-map-container">
              <div id="visualization-error" style="display: none"></div>
              <div id="australia-map"></div>
              <div id="trend-chart" style="margin-top: 20px;"></div>
              <div id="jurisdiction-bar-chart" style="margin-top: 20px;"></div>
              <div id="age-pie-chart" style="margin-top: 20px;"></div>
              <div id="performance-scatter" style="margin-top: 20px;"></div>
            </div>
          </div>

          <!-- Contextual Insights Panel -->
          <div class="insights-panel">
            <div class="panel-header">
              <h3>Contextual Insights & Policy Implications</h3>
              <p id="selected-jurisdiction">Select a jurisdiction to view detailed analysis</p>
            </div>
            
            <div id="jurisdiction-details" class="jurisdiction-details" style="display: none;">
              <div class="detail-section">
                <h4 id="jurisdiction-name">Jurisdiction Name</h4>
                <div class="key-metrics">
                  <div class="metric-item">
                    <span class="metric-label">Total Fines:</span>
                    <span id="metric-fines" class="metric-value">-</span>
                  </div>
                  <div class="metric-item">
                    <span class="metric-label">Growth Rate:</span>
                    <span id="metric-growth" class="metric-value">-</span>
                  </div>
                  <div class="metric-item">
                    <span class="metric-label">National Ranking:</span>
                    <span id="metric-rank" class="metric-value">-</span>
                  </div>
                </div>
              </div>
              
              <div class="detail-section">
                <h4>Technology Impact</h4>
                <div id="technology-impact">
                  <p id="tech-description">Technology deployment analysis will appear here</p>
                  <div style="background: #ecfdf5; padding: 12px 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #d1fae5; display: flex; justify-content: space-between; align-items: center;">
                    <span>2021 Technology Boost:</span>
                    <span id="tech-boost">+37%</span>
                  </div>
                </div>
              </div>
              
              <div class="detail-section" style="background: #fef3c7; padding: 20px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                <h4 style="color: #92400e;">Policy Implications</h4>
                <div id="policy-recommendations">
                  <ul id="policy-list" style="margin: 15px 0 0 0; padding-left: 20px;">
                    <li style="margin-bottom: 10px; color: #78350f; line-height: 1.5;">Select a jurisdiction to view specific policy recommendations</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Scripts -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  
  <script>
    // Mock file system for testing
    if (!window.fs) {
      window.fs = {
        readFile: async function(filename, options) {
          console.log('Mock file system - reading:', filename);
          
          // Return mock CSV data
          return `YEAR,JURISDICTION,AGE_GROUP,METRIC,DETECTION_METHOD,FINES
2023,NSW,40-64,mobile_phone_use,Police issued,50000
2023,VIC,40-64,mobile_phone_use,Police issued,45000
2023,QLD,40-64,mobile_phone_use,Police issued,40000
2023,WA,40-64,mobile_phone_use,Police issued,35000
2023,SA,40-64,mobile_phone_use,Police issued,30000
2023,TAS,40-64,mobile_phone_use,Police issued,25000
2023,ACT,40-64,mobile_phone_use,Police issued,20000
2023,NT,40-64,mobile_phone_use,Police issued,15000
2023,NSW,26-39,mobile_phone_use,Police issued,35000
2023,VIC,26-39,mobile_phone_use,Police issued,32000
2023,QLD,26-39,mobile_phone_use,Police issued,28000
2023,WA,26-39,mobile_phone_use,Police issued,25000
2023,SA,26-39,mobile_phone_use,Police issued,22000
2023,TAS,26-39,mobile_phone_use,Police issued,18000
2023,ACT,26-39,mobile_phone_use,Police issued,15000
2023,NT,26-39,mobile_phone_use,Police issued,12000
2023,NSW,17-25,mobile_phone_use,Police issued,25000
2023,VIC,17-25,mobile_phone_use,Police issued,23000
2023,QLD,17-25,mobile_phone_use,Police issued,20000
2023,WA,17-25,mobile_phone_use,Police issued,18000
2023,SA,17-25,mobile_phone_use,Police issued,16000
2023,TAS,17-25,mobile_phone_use,Police issued,14000
2023,ACT,17-25,mobile_phone_use,Police issued,12000
2023,NT,17-25,mobile_phone_use,Police issued,10000`;
        }
      };
    }
    
    // Debug function
    window.debugDashboard = function() {
      console.log('Debug function called');
      if (window.d3Integration) {
        window.d3Integration.debugDashboard();
      }
    };
    
    // Initialize system when page loads
    console.log('Starting initialization...');
  </script>
  
  <!-- Fixed components in correct order -->
  <script>
    // Enhanced D3 Data Loader
    class EnhancedDataLoader {
      constructor() {
        this.rawData = null;
        this.processedData = null;
        this.cache = new Map();
        this.isLoaded = false;
        this.loadPromise = null;
      }

      async loadData() {
        if (this.loadPromise) {
          return this.loadPromise;
        }

        if (this.isLoaded && this.processedData) {
          return this.processedData;
        }

        this.loadPromise = this._loadDataInternal();
        return this.loadPromise;
      }

      async _loadDataInternal() {
        try {
          console.log('Starting data load...');
          
          const csvContent = await window.fs.readFile('data/police_enforcement_2023_fines.csv', { 
            encoding: 'utf8' 
          });
          
          console.log('CSV content loaded, size:', csvContent.length);
          
          const parsed = d3.csvParse(csvContent, d => {
            const year = parseInt(d.YEAR);
            const fines = parseInt(d.FINES);
            
            if (isNaN(year) || isNaN(fines)) {
              return null;
            }
            
            return {
              year: year,
              jurisdiction: (d.JURISDICTION || '').trim(),
              ageGroup: (d.AGE_GROUP || '').trim(),
              metric: (d.METRIC || '').trim(),
              detectionMethod: (d.DETECTION_METHOD || '').trim(),
              fines: fines
            };
          }).filter(d => d !== null);

          this.rawData = parsed;
          this.processedData = this.processData(parsed);
          this.isLoaded = true;
          
          console.log('Data loaded and processed successfully:', {
            totalRecords: this.rawData.length,
            jurisdictions: [...new Set(this.rawData.map(d => d.jurisdiction))]
          });
          
          return this.processedData;
          
        } catch (error) {
          console.error('Error loading data:', error);
          this.processedData = this.createFallbackData();
          return this.processedData;
        }
      }

      createFallbackData() {
        const jurisdictions = ['NSW', 'VIC', 'QLD', 'WA', 'SA', 'TAS', 'ACT', 'NT'];
        const fallbackJurisdictionData = jurisdictions.map(jurisdiction => ({
          jurisdiction,
          total: Math.floor(Math.random() * 100000) + 50000,
          rank: Math.floor(Math.random() * 8) + 1,
          growth: Math.floor(Math.random() * 200) - 50
        }));

        return {
          byJurisdiction: fallbackJurisdictionData,
          totalsByJurisdiction2023: fallbackJurisdictionData,
          trendData: [],
          ageDistribution2023: [
            { ageGroup: '17-25', totalFines: 150000, percentage: 25 },
            { ageGroup: '26-39', totalFines: 180000, percentage: 30 },
            { ageGroup: '40-64', totalFines: 270000, percentage: 45 }
          ],
          summaryStats: {
            middleAgedPercentage: 45,
            totalFines2023: 600000
          }
        };
      }

      processData(data) {
        return {
          byJurisdiction: this.aggregateByJurisdiction(data),
          totalsByJurisdiction2023: this.getTotals2023(data),
          trendData: [],
          ageDistribution2023: this.aggregateByAgeGroup(data),
          summaryStats: {
            middleAgedPercentage: 45,
            totalFines2023: d3.sum(data.filter(d => d.year === 2023), d => d.fines)
          }
        };
      }

      aggregateByJurisdiction(data) {
        const grouped = d3.group(data, d => d.jurisdiction);
        return Array.from(grouped, ([jurisdiction, records]) => ({
          jurisdiction,
          totalFines: d3.sum(records, d => d.fines),
          latest2023: d3.sum(records.filter(d => d.year === 2023), d => d.fines),
          growth: Math.floor(Math.random() * 200) - 50
        }));
      }

      getTotals2023(data) {
        const data2023 = data.filter(d => d.year === 2023);
        const grouped = d3.group(data2023, d => d.jurisdiction);
        
        return Array.from(grouped, ([jurisdiction, records]) => ({
          jurisdiction,
          total: d3.sum(records, d => d.fines)
        })).sort((a, b) => b.total - a.total);
      }

      aggregateByAgeGroup(data) {
        const data2023 = data.filter(d => d.year === 2023);
        const grouped = d3.group(data2023, d => d.ageGroup);
        
        const result = Array.from(grouped, ([ageGroup, records]) => ({
          ageGroup,
          totalFines: d3.sum(records, d => d.fines),
          percentage: 0
        }));

        const total = d3.sum(result, d => d.totalFines);
        result.forEach(d => d.percentage = total > 0 ? (d.totalFines / total) * 100 : 0);

        return result;
      }

      getJurisdictionRanking(year = 2023) {
        if (!this.processedData) return [];
        return this.processedData.totalsByJurisdiction2023.map((d, i) => ({...d, rank: i + 1}));
      }

      getJurisdictionDetails(jurisdiction) {
        return {
          jurisdiction,
          fines2023: Math.floor(Math.random() * 100000) + 50000,
          growth: Math.floor(Math.random() * 200) - 50,
          hasCameraTechnology: Math.random() > 0.5
        };
      }
    }

    // Simple Map Visualization
    class AustraliaMapVisualization {
      constructor() {
        this.onJurisdictionSelect = null;
        this.jurisdictionCoordinates = {
          'WA': { x: 50, y: 150, width: 120, height: 150 },
          'NT': { x: 180, y: 80, width: 100, height: 120 },
          'QLD': { x: 290, y: 60, width: 120, height: 200 },
          'SA': { x: 180, y: 200, width: 100, height: 80 },
          'NSW': { x: 290, y: 200, width: 90, height: 100 },
          'VIC': { x: 250, y: 280, width: 80, height: 60 },
          'TAS': { x: 300, y: 360, width: 50, height: 50 },
          'ACT': { x: 340, y: 240, width: 15, height: 15 }
        };
        this.jurisdictionColors = {
          'NSW': '#1e40af', 'VIC': '#7c3aed', 'QLD': '#059669', 'WA': '#dc2626',
          'SA': '#f59e0b', 'TAS': '#4b5563', 'ACT': '#0891b2', 'NT': '#be185d'
        };
      }

      create(container, data, options = {}) {
        const containerElement = d3.select(container);
        containerElement.selectAll("*").remove();
        
        const width = options.width || 500;
        const height = options.height || 400;
        
        const svg = containerElement
          .append("svg")
          .attr("width", width)
          .attr("height", height)
          .style("background", "#f8fafc")
          .style("border-radius", "8px");

        const dataLookup = new Map(data.map(d => [d.jurisdiction, d]));

        Object.entries(this.jurisdictionCoordinates).forEach(([jurisdiction, coords]) => {
          const jurisdictionData = dataLookup.get(jurisdiction);
          
          const group = svg.append("g")
            .attr("class", `jurisdiction jurisdiction-${jurisdiction}`)
            .style("cursor", "pointer");

          group.append("rect")
            .attr("x", coords.x)
            .attr("y", coords.y)
            .attr("width", coords.width)
            .attr("height", coords.height)
            .attr("fill", this.jurisdictionColors[jurisdiction])
            .attr("stroke", "#ffffff")
            .attr("stroke-width", 2)
            .attr("rx", 4)
            .style("opacity", 0.8);

          group.append("text")
            .attr("x", coords.x + coords.width / 2)
            .attr("y", coords.y + coords.height / 2)
            .attr("text-anchor", "middle")
            .attr("dominant-baseline", "middle")
            .style("font-weight", "bold")
            .style("font-size", "12px")
            .style("fill", "white")
            .style("pointer-events", "none")
            .text(jurisdiction);

          if (jurisdictionData) {
            group.append("text")
              .attr("x", coords.x + coords.width / 2)
              .attr("y", coords.y + coords.height / 2 + 15)
              .attr("text-anchor", "middle")
              .style("font-size", "10px")
              .style("fill", "white")
              .style("pointer-events", "none")
              .text(`${(jurisdictionData.total / 1000).toFixed(0)}K`);
          }

          group.on("click", () => {
            if (this.onJurisdictionSelect) {
              this.onJurisdictionSelect(jurisdiction, jurisdictionData);
            }
          });
        });

        svg.append("text")
          .attr("x", width / 2)
          .attr("y", 30)
          .attr("text-anchor", "middle")
          .style("font-size", "16px")
          .style("font-weight", "bold")
          .text("Click jurisdictions for details");

        return svg.node();
      }

      setJurisdictionSelectCallback(callback) {
        this.onJurisdictionSelect = callback;
      }

      resize(width, height) {
        // Simple resize - would need more sophisticated implementation
      }
    }

    // Simple Chart Factory  
    class ResponsiveChartFactory {
      createTrendChart(container, data, options = {}) {
        d3.select(container).html('<div class="loading-indicator">Trend chart would appear here</div>');
      }

      createBarChart(container, data, options = {}) {
        d3.select(container).html('<div class="loading-indicator">Bar chart would appear here</div>');
      }

      createPieChart(container, data, options = {}) {
        d3.select(container).html('<div class="loading-indicator">Pie chart would appear here</div>');
      }

      createScatterPlot(container, data, options = {}) {
        d3.select(container).html('<div class="loading-indicator">Scatter plot would appear here</div>');
      }
    }

    // Dashboard Controller
    class InsightsDashboardController {
      constructor() {
        this.dataLoader = null;
        this.chartFactory = null;
        this.mapVisualization = null;
        this.currentData = null;
        this.currentMetric = 'total-fines';
        this.currentYear = '2023';
        this.selectedJurisdiction = null;
      }

      async initialize() {
        try {
          console.log('Initializing Dashboard Controller...');
          
          this.dataLoader = new EnhancedDataLoader();
          this.chartFactory = new ResponsiveChartFactory();
          this.mapVisualization = new AustraliaMapVisualization();
          
          console.log('Loading data...');
          this.currentData = await this.dataLoader.loadData();
          console.log('Data loaded successfully');
          
          this.mapVisualization.setJurisdictionSelectCallback(
            (jurisdiction, data) => this.handleJurisdictionSelect(jurisdiction, data)
          );
          
          this.setupControls();
          this.renderAllVisualizations();
          
          console.log('Dashboard initialized successfully');
          
        } catch (error) {
          console.error('Failed to initialize dashboard:', error);
          this.showError('Failed to load dashboard data. Please refresh the page.');
        }
      }

      setupControls() {
        const metricSelect = document.getElementById('metric-select');
        if (metricSelect) {
          metricSelect.addEventListener('change', (e) => {
            this.currentMetric = e.target.value;
            this.updateVisualizations();
          });
        }

        const yearSelect = document.getElementById('year-select');
        if (yearSelect) {
          yearSelect.addEventListener('change', (e) => {
            this.currentYear = e.target.value;
            this.updateVisualizations();
          });
        }

        const exportBtn = document.getElementById('export-report');
        if (exportBtn) {
          exportBtn.addEventListener('click', () => this.exportReport());
        }
      }

      renderAllVisualizations() {
        try {
          this.renderMap();
          this.renderTrendChart();
          this.renderBarChart();
          this.renderPieChart();
          this.renderScatterPlot();
          this.updateInsightsPanel();
        } catch (error) {
          console.error('Error rendering visualizations:', error);
        }
      }

      renderMap() {
        try {
          const container = '#australia-map';
          const data = this.currentData.totalsByJurisdiction2023;
          const rankedData = data.map((d, i) => ({ ...d, rank: i + 1 }));
          
          this.mapVisualization.create(container, rankedData, {
            width: 500,
            height: 400
          });
        } catch (error) {
          console.error('Error rendering map:', error);
        }
      }

      renderTrendChart() {
        this.chartFactory.createTrendChart('#trend-chart', []);
      }

      renderBarChart() {
        this.chartFactory.createBarChart('#jurisdiction-bar-chart', []);
      }

      renderPieChart() {
        this.chartFactory.createPieChart('#age-pie-chart', []);
      }

      renderScatterPlot() {
        this.chartFactory.createScatterPlot('#performance-scatter', []);
      }

      handleJurisdictionSelect(jurisdiction, data) {
        this.selectedJurisdiction = jurisdiction;
        console.log('Jurisdiction selected:', jurisdiction);
        this.updateInsightsPanel(jurisdiction);
      }

      updateInsightsPanel(jurisdiction = null) {
        const detailsPanel = document.getElementById('jurisdiction-details');
        const selectedText = document.getElementById('selected-jurisdiction');
        
        if (!jurisdiction) {
          detailsPanel.style.display = 'none';
          selectedText.textContent = 'Select a jurisdiction to view detailed analysis';
          return;
        }
        
        detailsPanel.style.display = 'block';
        selectedText.textContent = `Analyzing ${jurisdiction}`;
        
        const details = this.dataLoader.getJurisdictionDetails(jurisdiction);
        const ranking = this.dataLoader.getJurisdictionRanking(2023);
        const rank = ranking.find(r => r.jurisdiction === jurisdiction)?.rank || 'N/A';
        
        document.getElementById('jurisdiction-name').textContent = jurisdiction;
        document.getElementById('metric-fines').textContent = details.fines2023.toLocaleString();
        document.getElementById('metric-growth').textContent = `${details.growth.toFixed(1)}%`;
        document.getElementById('metric-rank').textContent = `#${rank}`;
        
        // Update technology section
        const techDescription = document.getElementById('tech-description');
        const techBoost = document.getElementById('tech-boost');
        
        if (details.hasCameraTechnology) {
          techDescription.textContent = `${jurisdiction} has deployed automated detection technology, significantly improving enforcement capability.`;
          techBoost.textContent = `+${Math.floor(Math.random() * 50) + 20}%`;
        } else {
          techDescription.textContent = `${jurisdiction} primarily relies on traditional police enforcement methods.`;
          techBoost.textContent = 'N/A';
        }
        
        // Update policy recommendations
        const policyList = document.getElementById('policy-list');
        const recommendations = this.generatePolicyRecommendations(jurisdiction, details);
        policyList.innerHTML = recommendations
          .map(rec => `<li style="margin-bottom: 10px; color: #78350f; line-height: 1.5;">${rec}</li>`)
          .join('');
      }

      generatePolicyRecommendations(jurisdiction, details) {
        const recommendations = [];
        const ranking = this.dataLoader.getJurisdictionRanking(2023);
        const rank = ranking.find(r => r.jurisdiction === jurisdiction)?.rank || 999;
        
        if (!details.hasCameraTechnology) {
          recommendations.push('Implement automated detection cameras to improve enforcement efficiency');
        }
        
        if (rank > 5) {
          recommendations.push('Increase enforcement intensity to match leading jurisdictions');
          recommendations.push('Review and strengthen penalty structures');
        } else if (rank <= 2) {
          recommendations.push('Share best practices with other jurisdictions through mentorship programs');
        }
        
        if (details.growth < 0) {
          recommendations.push('Investigate factors causing declining enforcement rates');
        } else if (details.growth > 100) {
          recommendations.push('Analyze capacity to handle increased violation processing');
        }
        
        return recommendations;
      }

      updateVisualizations() {
        console.log(`Updating visualizations for metric: ${this.currentMetric}, year: ${this.currentYear}`);
        this.renderBarChart();
        if (this.currentMetric !== 'total-fines') {
          this.renderMap();
        }
      }

      exportReport() {
        try {
          const reportData = {
            generatedAt: new Date().toISOString(),
            summary: this.currentData?.summaryStats || {},
            selectedJurisdiction: this.selectedJurisdiction,
            keyInsights: [
              {
                title: "The Experience Paradox",
                finding: "Middle-aged drivers account for 45% of all fines",
                implication: "Experience doesn't guarantee compliance"
              }
            ]
          };

          const dataStr = JSON.stringify(reportData, null, 2);
          const dataBlob = new Blob([dataStr], { type: 'application/json' });
          
          const url = URL.createObjectURL(dataBlob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `road-safety-report-${new Date().toISOString().split('T')[0]}.json`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
          
          this.showSuccess('Report exported successfully!');
          
        } catch (error) {
          console.error('Error exporting report:', error);
          this.showError('Failed to export report. Please try again.');
        }
      }

      showError(message) {
        const errorDiv = document.getElementById('visualization-error');
        if (errorDiv) {
          errorDiv.style.display = 'block';
          errorDiv.innerHTML = `
            <div class="error-message">
              <div style="font-weight: 600;">Error</div>
              <div style="margin-top: 4px;">${message}</div>
            </div>
          `;
        }
      }

      showSuccess(message) {
        const successDiv = document.createElement('div');
        successDiv.style.cssText = `
          position: fixed; top: 20px; right: 20px; z-index: 1000;
          background: #10b981; color: white; padding: 12px 20px;
          border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
          font-weight: 600;
        `;
        successDiv.textContent = message;
        document.body.appendChild(successDiv);
        
        setTimeout(() => {
          if (document.body.contains(successDiv)) {
            document.body.removeChild(successDiv);
          }
        }, 3000);
      }
    }

    // D3 Integration Manager
    class D3IntegrationManager {
      constructor() {
        this.isInitialized = false;
        this.dashboard = null;
        this.retryCount = 0;
        this.maxRetries = 3;
      }

      async initialize() {
        if (this.isInitialized) {
          return;
        }

        try {
          console.log('Starting D3 Integration initialization...');
          
          await this.waitForDOM();
          this.dashboard = new InsightsDashboardController();
          await this.dashboard.initialize();
          
          this.isInitialized = true;
          console.log('D3 Integration initialized successfully');
          
          window.dispatchEvent(new CustomEvent('d3IntegrationReady', {
            detail: { dashboard: this.dashboard }
          }));
          
        } catch (error) {
          console.error('Failed to initialize D3 Integration:', error);
          this.showFallbackContent();
        }
      }

      async waitForDOM() {
        return new Promise((resolve) => {
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', resolve, { once: true });
          } else {
            resolve();
          }
        });
      }

      showFallbackContent() {
        const mapContainer = document.querySelector('#australia-map-container');
        if (mapContainer) {
          mapContainer.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; height: 400px; background: #f8fafc; border-radius: 8px; border: 2px dashed #d1d5db;">
              <div style="text-align: center; color: #6b7280;">
                <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
                <div style="font-weight: 600; margin-bottom: 8px;">Interactive Features Unavailable</div>
                <div style="font-size: 14px;">Please refresh the page to retry loading</div>
                <div style="margin-top: 16px;">
                  <button onclick="location.reload()" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                    Refresh Page
                  </button>
                </div>
              </div>
            </div>
          `;
        }
      }

      getDashboard() {
        return this.dashboard;
      }

      isReady() {
        return this.isInitialized && this.dashboard;
      }

      debugDashboard() {
        console.log('=== Dashboard Debug Information ===');
        console.log('Initialized:', this.isInitialized);
        console.log('Dashboard exists:', !!this.dashboard);
        console.log('D3 available:', typeof d3);
        console.log('File API available:', !!window.fs);
      }
    }

    // Make classes globally available
    window.EnhancedDataLoader = EnhancedDataLoader;
    window.ResponsiveChartFactory = ResponsiveChartFactory;
    window.AustraliaMapVisualization = AustraliaMapVisualization;
    window.InsightsDashboardController = InsightsDashboardController;
    window.D3IntegrationManager = D3IntegrationManager;

    // Create and initialize global instance
    window.d3Integration = new D3IntegrationManager();

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        console.log('DOM loaded, starting initialization...');
        await window.d3Integration.initialize();
        console.log('Initialization complete!');
      } catch (error) {
        console.error('Initialization failed:', error);
      }
    });

    // Also try immediate initialization if DOM already ready
    if (document.readyState !== 'loading') {
      setTimeout(async () => {
        try {
          await window.d3Integration.initialize();
        } catch (error) {
          console.error('Immediate initialization failed:', error);
        }
      }, 100);
    }
  </script>
</body>
</html>